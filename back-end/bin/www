#!/usr/bin/env node

var app = require('../app');
var debug = require('debug')('adam-asiyoruz-backend:server');
var http = require('http');
var mongoose = require('mongoose');
var fs = require('fs');
var path = require('path');

require('dotenv').config();

const { version, author, license, name } = require('../package.json');


var port = normalizePort(process.env.PORT || '3000');
app.set('port', port);


var server = http.createServer(app);


mongoose
  .connect(process.env.MONGO_URI, { useNewUrlParser: true, useUnifiedTopology: true })
  .then(() => {
    console.info(" ‚úîÔ∏è  Database baƒülantƒ±sƒ± ba≈üarƒ±lƒ±.");
    startServer();
  })
  .catch(err => {
    console.error(" ‚ùå  Database baƒülantƒ±sƒ± ba≈üarƒ±sƒ±z:", err);
    process.exit(1);
  });


function startServer() {
  server.listen(port, () => {
    console.info(" ------------------------------------");
    console.info(` üéâ Sunucu dinlemede: PORT = ${port}`);
    console.info(` ‚ÑπÔ∏è  NODE_ENV:   ${process.env.NODE_ENV}`);
    console.info(` ‚ÑπÔ∏è  Service Name: ${name}`);
    console.info(` ‚ÑπÔ∏è  Version:    ${version}`);
    console.info(` ‚ÑπÔ∏è  Author:     ${author}`);
    console.info(` ‚ÑπÔ∏è  License:    ${license}`);
    console.info(" ------------------------------------");
    if (process.env.NODE_ENV === 'production') {
      const clientBuildPath = path.join(__dirname, '../public');
      if (fs.existsSync(clientBuildPath)) {
        console.info(" ‚úîÔ∏è  Client build dosyasƒ± mevcut.");
      } else {
        console.info(" ‚ùå  Client build dosyasƒ± bulunamadƒ±!");
      }
    }
  });
}

server.on('error', onError);


function normalizePort(val) {
  var port = parseInt(val, 10);
  if (isNaN(port)) {
    return val;
  }
  if (port >= 0) {
    return port;
  }
  return false;
}


function onError(error) {
  if (error.syscall !== 'listen') {
    throw error;
  }
  var bind = typeof port === 'string'
    ? 'Pipe ' + port
    : 'Port ' + port;
  switch (error.code) {
    case 'EACCES':
      console.error(' ‚ùå  ' + bind + ' requires elevated privileges');
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(' ‚ùå  ' + bind + ' is already in use');
      process.exit(1);
      break;
    default:
      throw error;
  }
}
